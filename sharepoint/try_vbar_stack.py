from bokeh.plotting import show, figure, ColumnDataSourcefrom bokeh.models import ColumnDataSource, HoverTool,  DatetimeTickFormatter, Legendfrom bokeh.palettes import linear_palette, Turbo256, diverging_palette, Plasma256from bokeh.transform import factor_cmap, transformimport pandas as pdimport numpy as npfrom Mapi2 import DBconx, Orgwith DBconx('t') as d:    tuptup = d.query(f"SELECT imei, checked_on, last_measure_at, count, org from `M+_daily` "                     f"WHERE last_measure_at > '2022.01.01' AND last_measure_at <= NOW()")    #tuptup = d.query("SELECT md.*, mo.name FROM `M+_daily` md JOIN `M+_orgs` mo ON md.org = mo.id")orgDict  = Org.getOrg_Name_dict()df1 = pd.DataFrame([i for i in tuptup])df1.columns = ['imei', 'checked', 'last', 'count', 'org']df1.astype({'imei': np.int64, 'count' : np.int16, 'org': np.int8}) # no effect 'last' : '<M8[s]'})df1.org = df1.org.map(orgDict) #.astype('category')df1.set_index('last', drop=False, inplace=True)df1.sort_index(inplace=True)df1.info()org_stack_wk = df1.groupby([pd.Grouper(level=0, freq='W'), 'org'])['imei'].nunique().to_frame().unstack(level=1, fill_value=0).T.reset_index(level=0, drop=True).T#.unstack(level=1, fill_value=0)org_stack_wk = org_stack_wk[sorted(org_stack_wk.columns)]org_stack_wk['TWk'] = org_stack_wk.sum(axis=1, numeric_only=True)org_stack_wk.info()source_org_stack_wk = ColumnDataSource(org_stack_wk)no_orgs = df1.groupby('org').nunique().index.to_list()#org_cmap = factor_cmap('last', palette=diverging_palette(Reds256, Greys256[::-1], (len(no_orgs)), 0.7), factors= no_orgs)org_cmap = factor_cmap('last', palette=linear_palette(Turbo256[30:], len(no_orgs)), factors= no_orgs)p2 = figure(plot_width=480, plot_height=360, title=" Active devices by week by Org",            outline_line_color=None, x_axis_type = 'datetime',            toolbar_location=None) #, tools="", x_range=source_org_stack_wk.data['last'],p2.add_layout(Legend(), 'right')p2.vbar_stack(x='last', stackers=no_orgs, width=900*3600*24*7,  source=source_org_stack_wk,              color=org_cmap['transform'].palette[:len(no_orgs)],              legend_label=[str(x)[0:5] for x in no_orgs]              ) #, view=view_org_stack_wk) #, source=source1hovertool1= HoverTool(tooltips=[("wk ending", "@last{%d %b}"), ("Org name", "$name"), ("count", "@$name"),], formatters={"@last" : 'datetime'})p2.add_tools(hovertool1)p2.xgrid.visible = Falsep2.ygrid.visible = Falsep2.legend.location = 'right'p2.legend.orientation = "vertical"p2.legend.label_text_font_size = '9px'# p2.legend.label_standoff = 2# #p2.legend.label_width = 5#p2.legend.label_height = 12p2.legend.glyph_width = 5p2.legend.glyph_height = 12p2.legend.spacing = 0p2.legend.padding = 0p2.legend.margin = 0p2.legend.background_fill_alpha = 0p2.legend.items.reverse()#p2.xaxis.ticker =  SingleIntervalTicker(interval=2)p2.xaxis.formatter = DatetimeTickFormatter(months="%b %y")show(p2)